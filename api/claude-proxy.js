export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { type, question, topic, prompt } = req.body;

    let messages = [];
    let system = undefined;
    let maxTokens = 1024;

    if (type === 'generate') {
      maxTokens = 4096;
      messages = [{ role: 'user', content: prompt || '–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —É—Ä–æ–∫ –ø–æ —Ç–µ–º–µ: ' + topic }];

    } else if (type === 'answer_with_board') {
      maxTokens = 2048;
      system = `–¢—ã –ú–∞—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞ ‚Äî —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, 10 –ª–µ—Ç –æ–ø—ã—Ç–∞, –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞—É–∫. –£—á–µ–Ω–∏–∫ –ø—Ä–µ—Ä–≤–∞–ª —Ç–µ–±—è –≤–æ–ø—Ä–æ—Å–æ–º.

–ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥. –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–∞–≤–∞–π –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π –Ω–∞–≤–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç–æ–ª–∫–Ω—ë—Ç —É—á–µ–Ω–∏–∫–∞ –∫ –æ—Ç–≤–µ—Ç—É —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
2. –î–∞–π –ø–æ–¥—Å–∫–∞–∑–∫—É-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –Ω–æ –ù–ï –æ—Ç–≤–µ—Ç
3. –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—á–µ–Ω–∏–∫ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª —ç—Ç–æ –∂–µ –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç "–Ω–µ –∑–Ω–∞—é" / "–Ω–µ –ø–æ–Ω–∏–º–∞—é" ‚Äî —Ç–æ–≥–¥–∞ –æ–±—ä—è—Å–Ω–∏

–ü—Ä–∏–º–µ—Ä—ã:
- –£—á–µ–Ω–∏–∫: "–ö–∞–∫ –Ω–∞–π—Ç–∏ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç?" ‚Üí –¢—ã: "–ê –≤—Å–ø–æ–º–Ω–∏, –∫–∞–∫–∏–µ —Ç—Ä–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–∏? –ß—Ç–æ —Å –Ω–∏–º–∏ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"
- –£—á–µ–Ω–∏–∫: "–ù–µ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è" ‚Üí –¢—ã: "–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –µ–¥–µ—à—å –Ω–∞ –º–∞—à–∏–Ω–µ. –°–ø–∏–¥–æ–º–µ—Ç—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –º–µ–Ω—è–µ—Ç—Å—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ. –¢–∞–∫ –≤–æ—Ç, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å —Ç–∞–∫–æ–π —Å–ø–∏–¥–æ–º–µ—Ç—Ä –¥–ª—è –ª—é–±–æ–π —Ñ—É–Ω–∫—Ü–∏–∏. –ö–∞–∫—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è –∏–∫—Å –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ?"
- –£—á–µ–Ω–∏–∫: "–ù–µ –∑–Ω–∞—é" ‚Üí –¢–æ–≥–¥–∞ –æ–±—ä—è—Å–Ω–∏ –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ

–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ JSON –±–µ–∑ markdown-–æ–±—ë—Ä—Ç–æ–∫:
{"answer": "—Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏", "board": [{"type": "formula", "content": "LaTeX"}, {"type": "text", "content": "–ø–æ—è—Å–Ω–µ–Ω–∏–µ"}]}

–ü—Ä–∞–≤–∏–ª–∞:
- answer: –∫–æ—Ä–æ—Ç–∫–æ, 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ñ–æ—Ä–º—É–ª—ã —Å–ª–æ–≤–∞–º–∏
- board: 1-3 —ç–ª–µ–º–µ–Ω—Ç–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –Ω–∞ –¥–æ—Å–∫–µ
- –í –∫–æ–Ω—Ü–µ —Å–∫–∞–∂–∏ "–ü–æ–Ω—è—Ç–Ω–æ? –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º?" –∏–ª–∏ –ø–æ—Ö–æ–∂–µ–µ
- JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º

–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞: ${topic}`;
      messages = [{ role: 'user', content: question }];

    } else if (type === 'answer') {
      system = `–¢—ã –ú–∞—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞ ‚Äî —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥: –Ω–µ –¥–∞–≤–∞–π –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç, –∞ –∑–∞–¥–∞–π –Ω–∞–≤–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å. –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—á–µ–Ω–∏–∫ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç ‚Äî –æ–±—ä—è—Å–Ω–∏. –§–æ—Ä–º—É–ª—ã –ø—Ä–æ–∏–∑–Ω–æ—Å–∏ —Å–ª–æ–≤–∞–º–∏. –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞: ${topic}`;
      messages = [{ role: 'user', content: question }];

    } else {
      return res.status(400).json({ error: 'Invalid type' });
    }

    const body = {
      model: 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      messages: messages,
    };
    if (system) body.system = system;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': process.env.ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify(body),
    });

    if (!response.ok) {
      const err = await response.text();
      console.error('Anthropic API error:', err);
      return res.status(500).json({ error: 'Anthropic API error', details: err });
    }

    const data = await response.json();
    const text = data.content
      .filter((block) => block.type === 'text')
      .map((block) => block.text)
      .join('');

    if (type === 'generate') {
      try {
        const cleaned = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const lesson = JSON.parse(cleaned);
        return res.status(200).json({ lesson });
      } catch (parseError) {
        return res.status(200).json({ answer: text });
      }
    }

    if (type === 'answer_with_board') {
      try {
        const cleaned = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const parsed = JSON.parse(cleaned);
        return res.status(200).json({
          answer: parsed.answer || text,
          board: parsed.board || [],
        });
      } catch (parseError) {
        return res.status(200).json({ answer: text, board: [] });
      }
    }

    return res.status(200).json({ answer: text });

  } catch (error) {
    console.error('Proxy error:', error);
    return res.status(500).json({ error: 'Internal server error', details: error.message });
  }
}
```

Commit changes, –ø–æ–¥–æ–∂–¥–∏ –¥–µ–ø–ª–æ–π.

---

**–®–∞–≥ 2 ‚Äî Bolt.** –ö–æ–ø–∏—Ä—É–π:
```
–í MathTutor.jsx –∑–∞–º–µ–Ω–∏ –ü–û–õ–ù–û–°–¢–¨–Æ —Ñ—É–Ω–∫—Ü–∏—é buildLessonPrompt –Ω–∞ —ç—Ç—É:

const buildLessonPrompt = (topic) => `–¢—ã –ú–∞—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞ ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. 35 –ª–µ—Ç, –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞—É–∫, 10 –ª–µ—Ç –≥–æ—Ç–æ–≤–∏—à—å –∫ –ï–ì–≠ –∏ –æ–ª–∏–º–ø–∏–∞–¥–∞–º. –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥: –Ω–µ –¥–∞—ë—à—å –≥–æ—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –∞ –ø–æ–¥–≤–æ–¥–∏—à—å —É—á–µ–Ω–∏–∫–∞ –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é —á–µ—Ä–µ–∑ –≤–æ–ø—Ä–æ—Å—ã –∏ –∞–Ω–∞–ª–æ–≥–∏–∏.

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —É—Ä–æ–∫ –ø–æ —Ç–µ–º–µ: "${topic}".

–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –±–µ–∑ markdown-–æ–±—ë—Ä—Ç–æ–∫, –±–µ–∑ \`\`\`, –ø—Ä–æ—Å—Ç–æ —á–∏—Å—Ç—ã–π JSON:
{
  "explanation": "—Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏",
  "board": [–º–∞—Å—Å–∏–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–æ—Å–∫–∏]
}

–ü–†–ê–í–ò–õ–ê –î–õ–Ø "explanation" (—Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏ –≤—Å–ª—É—Ö):
- –ù–∞—á–Ω–∏ –∫–æ—Ä–æ—Ç–∫–æ: "–¢–∞–∫, —Å–µ–≥–æ–¥–Ω—è —Ä–∞–∑–±–∏—Ä–∞–µ–º..." ‚Äî –±–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π
- –ì–æ–≤–æ—Ä–∏ –ö–ê–ö –ß–ï–õ–û–í–ï–ö, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥: –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ö–æ–¥—É –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
  –ù–∞–ø—Ä–∏–º–µ—Ä: "–ê –∫–∞–∫ –¥—É–º–∞–µ—à—å, —á—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç —Ä–∞–≤–µ–Ω –Ω—É–ª—é? –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –æ–¥–∏–Ω –∫–æ—Ä–µ–Ω—å!"
  –ò–ª–∏: "–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —Ç—ã –µ–¥–µ—à—å –Ω–∞ –º–∞—à–∏–Ω–µ –∏ —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ —Å–ø–∏–¥–æ–º–µ—Ç—Ä. –ß—Ç–æ –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç? –°–∫–æ—Ä–æ—Å—Ç—å! –í–æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏"
- –ß–µ—Ä–µ–¥—É–π: –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ ‚Üí –≤–æ–ø—Ä–æ—Å —É—á–µ–Ω–∏–∫—É ‚Üí —Å–∞–º –æ—Ç–≤–µ—á–∞–µ—à—å ‚Üí —Å–ª–µ–¥—É—é—â–∞—è –º—ã—Å–ª—å
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏ –∏–∑ –∂–∏–∑–Ω–∏
- –†–∞–∑–±–µ—Ä–∏ –ø—Ä–∏–º–µ—Ä —Å —á–∏—Å–ª–∞–º–∏ —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, —Å–ø—Ä–∞—à–∏–≤–∞—è "—á—Ç–æ –¥–∞–ª—å—à–µ?"
- –§–æ—Ä–º—É–ª—ã –ø—Ä–æ–∏–∑–Ω–æ—Å–∏ —Å–ª–æ–≤–∞–º–∏
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è. –ù–µ –ª–µ–π –≤–æ–¥—É
- –î–ª–∏–Ω–∞: 1-2 –º–∏–Ω—É—Ç—ã —Ä–µ—á–∏ –º–∞–∫—Å–∏–º—É–º
- –ë–µ–∑ LaTeX, –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤

–ü–†–ê–í–ò–õ–ê –î–õ–Ø "board" (–¥–æ—Å–∫–∞):
- 8-12 —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —á–µ—Ä–µ–¥—É–π text –∏ formula
- KaTeX-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π LaTeX –¥–ª—è —Ñ–æ—Ä–º—É–ª
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã —Å —ç–º–æ–¥–∑–∏: üìå üîë ‚ú® üìù üéØ ü§î
- –î–æ–±–∞–≤–ª—è–π —ç–ª–µ–º–µ–Ω—Ç—ã-–≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ—Å–∫–µ: "ü§î –ß—Ç–æ –µ—Å–ª–∏ D = 0?"
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π –ø—Ä–∏–º–µ—Ä —Å –ø–æ—à–∞–≥–æ–≤—ã–º —Ä–µ—à–µ–Ω–∏–µ–º
- –ü–û–õ–ù–´–ô –∫–æ–Ω—Å–ø–µ–∫—Ç –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–º—ã
- JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º`;

–ë–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–π.
