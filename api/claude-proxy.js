module.exports = async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  var ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;

  async function callClaude(system, userMessage, maxTokens, model) {
    var body = {
      model: model || 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      messages: [{ role: 'user', content: userMessage }],
    };
    if (system) body.system = system;

    var response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify(body),
    });

    if (!response.ok) {
      var err = await response.text();
      throw new Error('Anthropic API error: ' + err);
    }

    var data = await response.json();
    return data.content
      .filter(function(block) { return block.type === 'text'; })
      .map(function(block) { return block.text; })
      .join('');
  }

  try {
    var type = req.body.type;
    var question = req.body.question;
    var topic = req.body.topic;
    var prompt = req.body.prompt;

    if (type === 'generate') {
      var teacherSystem = '–¢—ã –ú–∞—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞, —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏. –¢–µ–±–µ 35, —Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞—É–∫, 10 –ª–µ—Ç –≥–æ—Ç–æ–≤–∏—à—å –∫ –ï–ì–≠. –¢—ã –ù–ï —Ä–æ–±–æ—Ç, —Ç—ã –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫.\n\n–°–µ–π—á–∞—Å —Ç—ã –æ–±—ä—è—Å–Ω—è–µ—à—å —Ç–µ–º—É —É—á–µ–Ω–∏–∫—É-–ø–æ–¥—Ä–æ—Å—Ç–∫—É. –ì–æ–≤–æ—Ä–∏ —Ç–∞–∫, –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–æ –≥–æ–≤–æ—Ä–∏—à—å –Ω–∞ —É—Ä–æ–∫–µ ‚Äî —Å –ø–∞—É–∑–∞–º–∏, –º–µ–∂–¥–æ–º–µ—Ç–∏—è–º–∏, —à—É—Ç–∫–∞–º–∏.\n\n–ö–ê–ö –ì–û–í–û–†–ò–¢–¨:\n- "–û–∫–µ–π, —Å–º–æ—Ç—Ä–∏..." "–¢–∞–∫, –¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º—Å—è..." "–í–æ—Ç —Å–º–æ—Ç—Ä–∏ –∫–∞–∫–∞—è —à—Ç—É–∫–∞..."\n- –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –∏ –¢–£–¢ –ñ–ï –æ—Ç–≤–µ—á–∞–π –∑–∞ —É—á–µ–Ω–∏–∫–∞: "–ö–∞–∫ –¥—É–º–∞–µ—à—å, —á—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è? –ù—É –¥–∞, –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –¥–≤–∞ –∫–æ—Ä–Ω—è!"\n- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞-—Å–≤—è–∑–∫–∏: "–∫—Å—Ç–∞—Ç–∏", "–º–µ–∂–¥—É –ø—Ä–æ—á–∏–º", "–∞ –≤–æ—Ç —Ç—É—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ"\n- –®—É—Ç–∏ –∏–Ω–æ–≥–¥–∞: "–î–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç ‚Äî –∑–≤—É—á–∏—Ç —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ –Ω–∞ –¥–µ–ª–µ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ"\n- –ê–Ω–∞–ª–æ–≥–∏–∏ –∏–∑ –∂–∏–∑–Ω–∏ –ø–æ–¥—Ä–æ—Å—Ç–∫–∞: —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–≥—Ä—ã, –¥–µ–Ω—å–≥–∏, –æ—Ü–µ–Ω–∫–∏\n\n–ö–ê–ö –ù–ï –ì–û–í–û–†–ò–¢–¨:\n- –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" –∏–ª–∏ "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é"\n- –ù–ï –≥–æ–≤–æ—Ä–∏ "–≤–∞–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å", "—Å–ª–µ–¥—É–µ—Ç –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å", "–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–Ω–∏–º–∞—Ç—å"\n- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç –∏ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å\n- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Ä–∞–∑–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏\n- –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π "–≤–æ-–ø–µ—Ä–≤—ã—Ö, –≤–æ-–≤—Ç–æ—Ä—ã—Ö"\n\n–°–¢–†–£–ö–¢–£–†–ê:\n1. –ó–∞—Ü–µ–ø–∏ –≤–Ω–∏–º–∞–Ω–∏–µ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) ‚Äî –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç\n2. –û–±—ä—è—Å–Ω–∏ —Å—É—Ç—å (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) ‚Äî –ø—Ä–æ—Å—Ç–æ, —Å –∞–Ω–∞–ª–æ–≥–∏–µ–π\n3. –ü–æ–∫–∞–∂–∏ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Å —á–∏—Å–ª–∞–º–∏ ‚Äî —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, —Å–ø—Ä–∞—à–∏–≤–∞—è "—á—Ç–æ –¥–∞–ª—å—à–µ?"\n4. –ü–æ–¥—ã—Ç–æ–∂—å (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)\n\n–§–æ—Ä–º—É–ª—ã –°–õ–û–í–ê–ú–ò: "–∏–∫—Å –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ", "–¥—ç —Ä–∞–≤–Ω–æ –±—ç –∫–≤–∞–¥—Ä–∞—Ç –º–∏–Ω—É—Å —á–µ—Ç—ã—Ä–µ –∞ —Ü—ç"\n–î–ª–∏–Ω–∞: 1-1.5 –º–∏–Ω—É—Ç—ã —Ä–µ—á–∏. –õ—É—á—à–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ —á–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ.\n–ë–µ–∑ LaTeX, –±–µ–∑ JSON. –ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –∫–∞–∫ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å –≤—Å–ª—É—Ö.';

      var boardSystem = '–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç-–∫–æ–Ω—Å–ø–µ–∫—Ç–∏—Å—Ç. –°–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Å–ø–µ–∫—Ç –¥–ª—è –¥–æ—Å–∫–∏ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç–µ–º–µ.\n\n–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ JSON –±–µ–∑ markdown-–æ–±—ë—Ä—Ç–æ–∫:\n[\n  { "type": "text", "content": "üìå –ó–∞–≥–æ–ª–æ–≤–æ–∫" },\n  { "type": "formula", "content": "LaTeX —Ñ–æ—Ä–º—É–ª–∞" }\n]\n\n–ü—Ä–∞–≤–∏–ª–∞:\n- 8-12 —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n- –ß–µ—Ä–µ–¥—É–π text –∏ formula\n- KaTeX-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π LaTeX\n- text: –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã —Å —ç–º–æ–¥–∑–∏ üìå üîë ‚ú® üìù üéØ ü§î\n- –í–æ–ø—Ä–æ—Å—ã: "ü§î –ß—Ç–æ –µ—Å–ª–∏ D = 0?"\n- –ß–∏—Å–ª–æ–≤–æ–π –ø—Ä–∏–º–µ—Ä —Å –ø–æ—à–∞–≥–æ–≤—ã–º —Ä–µ—à–µ–Ω–∏–µ–º\n- –ü–û–õ–ù–´–ô –∫–æ–Ω—Å–ø–µ–∫—Ç\n- –¢–æ–ª—å–∫–æ JSON –º–∞—Å—Å–∏–≤';

      var topicText = prompt || '–¢–µ–º–∞: ' + topic;

      var results = await Promise.all([
        callClaude(teacherSystem, topicText, 2048),
        callClaude(boardSystem, topicText, 2048, 'claude-haiku-4-5-20251001'),
      ]);

      var teacherText = results[0];
      var boardText = results[1];

      var board = [];
      try {
        var cleaned = boardText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        board = JSON.parse(cleaned);
        if (!Array.isArray(board)) board = [];
      } catch (e) {
        console.error('Board parse error:', e);
      }

      return res.status(200).json({
        lesson: { explanation: teacherText, board: board },
      });
    }

    if (type === 'answer_with_board') {
      var teacherSys = '–¢—ã –ú–∞—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞, —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏. –£—á–µ–Ω–∏–∫ –ø—Ä–µ—Ä–≤–∞–ª —É—Ä–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–º.\n\n–¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî —Å–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥, –Ω–æ –ü–û-–ß–ï–õ–û–í–ï–ß–ï–°–ö–ò:\n- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –≤–æ–ø—Ä–æ—Å —É—á–µ–Ω–∏–∫–∞\n- –ù–ï –≥–æ–≤–æ—Ä–∏ "–æ—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å" –∏–ª–∏ "—Ö–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å"\n- –°—Ä–∞–∑—É –∫ –¥–µ–ª—É\n\n–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π ‚Äî –∑–∞–¥–∞–π –Ω–∞–≤–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å:\n"–ê –≤—Å–ø–æ–º–Ω–∏, —á—Ç–æ –º—ã –¥–µ–ª–∞–ª–∏ —Å –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç–æ–º? –ö–∞–∫–∞—è —Ç–∞–º —Ñ–æ—Ä–º—É–ª–∞?"\n\n–ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ —è–≤–Ω–æ –∑–∞–ø—É—Ç–∞–ª—Å—è ‚Äî –æ–±—ä—è—Å–Ω–∏ –∫–æ—Ä–æ—Ç–∫–æ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–æ–≥–∏—é:\n"–°–º–æ—Ç—Ä–∏, —ç—Ç–æ –∫–∞–∫ —Ä–µ—Ü–µ–ø—Ç ‚Äî –±–µ—Ä—ë—à—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∞, –±—ç –∏ —Ü—ç –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—à—å –≤ —Ñ–æ—Ä–º—É–ª—É"\n\n–ü—Ä–∞–≤–∏–ª–∞:\n- 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–µ –±–æ–ª—å—à–µ\n- –§–æ—Ä–º—É–ª—ã —Å–ª–æ–≤–∞–º–∏\n- –ë–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞\n- –í –∫–æ–Ω—Ü–µ –∫–æ—Ä–æ—Ç–∫–æ: "–Ø—Å–Ω–æ? –ï–¥–µ–º –¥–∞–ª—å—à–µ?" –∏–ª–∏ "–ü–æ–Ω—è–ª? –ü—Ä–æ–¥–æ–ª–∂–∏–º?"\n- –ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ JSON\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞: ' + topic;

      var teacherAnswer = await callClaude(teacherSys, question, 1024);

      var boardSys = '–£—á–∏—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å. –ù—É–∂–Ω—ã –ª–∏ —Ñ–æ—Ä–º—É–ª—ã –Ω–∞ –¥–æ—Å–∫–µ?\n\n–ï—Å–ª–∏ –¥–∞ ‚Äî JSON –º–∞—Å—Å–∏–≤: [{"type": "formula", "content": "LaTeX"}, {"type": "text", "content": "–ø–æ—è—Å–Ω–µ–Ω–∏–µ"}]\n–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤: []\n\n–ú–∞–∫—Å–∏–º—É–º 1-3 —ç–ª–µ–º–µ–Ω—Ç–∞. –¢–æ–ª—å–∫–æ JSON.';

      var answerBoard = [];
      try {
        var boardResp = await callClaude(
          boardSys,
          '–í–æ–ø—Ä–æ—Å: ' + question + '\n–û—Ç–≤–µ—Ç: ' + teacherAnswer,
          512,
          'claude-haiku-4-5-20251001'
        );
        var cleanedBoard = boardResp.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        answerBoard = JSON.parse(cleanedBoard);
        if (!Array.isArray(answerBoard)) answerBoard = [];
      } catch (e) {
        console.error('Board parse error:', e);
      }

      return res.status(200).json({ answer: teacherAnswer, board: answerBoard });
    }

    if (type === 'answer') {
      var sys = '–¢—ã –ú–∞—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞, —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä. –°–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤–æ–ø—Ä–æ—Å, –Ω–µ –≥–æ–≤–æ—Ä–∏ "–æ—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å". –°—Ä–∞–∑—É –∫ –¥–µ–ª—É. –ù–∞–≤–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–æ–≥–∏—é. –§–æ—Ä–º—É–ª—ã —Å–ª–æ–≤–∞–º–∏. –ö–æ–Ω—Ç–µ–∫—Å—Ç: ' + topic;
      var answer = await callClaude(sys, question, 1024);
      return res.status(200).json({ answer: answer });
    }

    return res.status(400).json({ error: 'Invalid type' });

  } catch (error) {
    console.error('Proxy error:', error);
    return res.status(500).json({ error: 'Internal server error', details: error.message });
  }
};
